# Qiibee

## Description
SaaS Blockchain based project to help businesses track their codes/points/rewards.

## Components
1. API
2. Consumer (Broadway)
3. Database - MySQL (also the Blockchain layer)
4. Common Structs

## Running using Docker
```
    docker-compose rm -f; docker-compose up --build --remove-orphan
```
## Run for development
```
    docker-compose rm -f; docker-compose -f dev-docker-compose.yaml up --build --remove-orphan
    asdf install
    mix deps.get
    mix ecto.reset
    mix seed
    iex -S mix
```

## Running tests
```
    mix test
```

## API auth
1. To authenticate brands (Admin flow), please add an `x-api-key` header and a `brand_id` as a value.
2. To authenticate users (User flow), please add an `authorization` header and a `Bearer #{user_id}` as a value.

## Features planned

1. API layer:
   - [ ] Admin
       - [x] Auth
       - [ ] REST API
         - [x] Check user's balance (scope it to brand_id)
         - [ ] Credit a certain user some points (Earn)
         - [ ] Debit a certain user some points (Burn)
   - [ ] User
       - [x] Auth
       - [ ] REST API
         - [x] User registration
         - [x] Redeem code to get points
         - [ ] Redeem reward using points
         - [ ] Transactions history(tx hash will be the balance table binary_id using `String.replace("-", "")`)
         - [x] Mock email service

* Note: Each REST API operation will go through the API for validation first then get forwarded to RabbitMQ to be later consumed by Broadway.

1. Consumer layer:
   - [x] Setup RabbitMQ (queues/exchanges/dlxs)
   - [x] Connect to RabbitMQ and test it
   - [x] Create a user registration queue (for emails)
   - [ ] api -> admin -> consumer / publisher
   - [x] api -> user -> consumer / publisher (code to points)
   - [ ] Handle Dead-letters
   - [ ] Create a queue seeder (Publisher that will be used by the API)
   - [ ] Tests

2. Blockchain layer (Mock):
   - [x] Create app
   - [x] Create the balances table
   - [x] Add necessary operations to be used by Broadway
   - [x] Tests

3. Common structs app:
   - [x] Create admins
   - [x] Create brands (belongs to admins)
   - [x] Create users (belongs to brands)
   - [x] Create codes (belongs to brands)
   - [x] Create rewards (belongs to brands)
   - [x] Create a seeder
   - [x] Tests

## Production checklist

1. Soak test the whole project using multiple GenServers with Graphana and Prometheus installed to visualize performance.
2. Integration tests.
3. Move any hardcoded variables to a docker env file that is encrypted by AWS secrets manager (if we use AWS) for it to be decrypted at deployment.
4. CI/CD.
5. Delete all unused code and tests generated by mix `phx.gen.context` in the `Common` app.